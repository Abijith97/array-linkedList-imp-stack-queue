const https = require('https');
const fs = require('fs');

const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;
const PR_TITLE = process.env.PR_TITLE || 'Pull Request';

// Read the diff and commits from files
const diff = fs.readFileSync('/tmp/pr-diff.txt', 'utf8');
const commits = fs.readFileSync('/tmp/pr-commits.txt', 'utf8');

const prompt = `Analyze the following pull request and generate a comprehensive PR description.

PR Title: ${PR_TITLE}

Commits:
${commits}

Code Changes:
${diff}

Please generate a well-structured PR description with:
1. A summary section explaining what this PR does and why
2. Key changes made (bullet points)
3. A test plan section with steps to verify the changes

Format the response in markdown. Keep it concise but informative.`;

const requestBody = JSON.stringify({
  model: 'claude-sonnet-4-5-20250929',
  max_tokens: 2000,
  messages: [
    {
      role: 'user',
      content: prompt
    }
  ]
});

const options = {
  hostname: 'api.anthropic.com',
  path: '/v1/messages',
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'x-api-key': ANTHROPIC_API_KEY,
    'anthropic-version': '2023-06-01',
    'Content-Length': Buffer.byteLength(requestBody)
  }
};

const req = https.request(options, (res) => {
  let data = '';

  res.on('data', (chunk) => {
    data += chunk;
  });

  res.on('end', () => {
    try {
      const response = JSON.parse(data);

      if (response.content && response.content[0] && response.content[0].text) {
        const description = response.content[0].text;

        // Add footer attribution
        const fullDescription = `${description}

---
ü§ñ *PR description auto-generated by [Claude](https://claude.ai)*`;

        // Write to file for the next step
        fs.writeFileSync('/tmp/generated-description.txt', fullDescription);
        console.log('‚úÖ Successfully generated PR description');
      } else {
        console.error('‚ùå Unexpected API response format:', response);
        process.exit(1);
      }
    } catch (error) {
      console.error('‚ùå Error parsing response:', error);
      console.error('Raw response:', data);
      process.exit(1);
    }
  });
});

req.on('error', (error) => {
  console.error('‚ùå Request error:', error);
  process.exit(1);
});

req.write(requestBody);
req.end();
